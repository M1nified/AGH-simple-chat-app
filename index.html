<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Komunikator</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" charset="utf-8"></script>
  <!-- <script src="com.js" charset="utf-8"></script> -->
  <script type="text/javascript">
  'use strict';
  // $(()=>{
  //   console.log(document.chat);
  //   $(document.form).on('submit',function(event){
  //     event.preventDefault();
  //     console.log('SUBMIT')
  //   })
  //   (function poll(){
  //     setTimeout(function(){
  //       $.ajax({ url: "server", success: function(data){
  //
  //         poll();
  //       }, dataType: "json"});
  //     }, 30000);
  //   })();
  // });

  $(()=>{
    var ws = null;
    var gothist = false;
    var runSocket = function runSocket(){
      var promise = new Promise((resolve,reject)=>{
        if("WebSocket" in window){
          var host = location.origin.replace(/^http/, 'ws')
          ws = new WebSocket(host);
          ws.onopen = function wsopen(){
            resolve();
          }
          ws.onmessage = function wsonmessage(msg){
            console.log(msg);
            var data = msg.data;
            try{
              data = JSON.parse(data);
            }catch(e){
              data = null;
            }
            if(data){
              if(data.type==='message'){
                printMsg(data);
              }else if(data.type==='history' && gothist === true){
                gothist = true;
                $("#chat").val('');
                for(var m of data.history){
                  printMsg(m)
                }
              }
            }
          }
          ws.onclose = function wsonclose(evt){
            // setTimeout(runSocket,1000)
          }
          ws.onerror = function wsonerror(evt){
            console.error(evt);
            // reject();
            // setTimeout(runSocket,1000)
          }
        }else{
          reject('WebSocket NOT SUPPORTED');
        }
      })
      return promise;
    };
    runSocket();
    $(document.form).on('submit',function(event){
      event.preventDefault();
      // console.log('SUBMIT')
      // Construct a msg object containing the data the server needs to process the message from the chat client.
      var msg = {
        type: "message",
        text: $("#msg").val(),
        imie:   $("#imie").val() || 'anon',
        date: Date.now()
      };

      // Send the msg object as a JSON-formatted string.
      if(!ws || ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING){
        runSocket().then(()=>{
          ws.send(JSON.stringify(msg));
        }).catch((err)=>{
          console.error(err);
        })
      }else{
        ws.send(JSON.stringify(msg));
      }

      // Blank the text input element, ready to receive the next line of text from the user.
      $("#msg").val('');
    })
    $("#isActive").change(function(e){
      if(this.checked){
        runSocket();
      }else{
        ws.close();
      }
    })
  })
  var printMsg = function(data){
    console.log(data);
    var chat = $("#chat");
    chat[0].value += '\n'+data.imie+': '+data.text;
    chat.scrollTop(chat.prop('scrollHeight'));
  }

  </script>
</head>
<body>
  <textarea id="chat" rows="8" cols="40" readonly></textarea>
  <br>
  <input type="checkbox" id="isActive">
  <form class="" action="#" name=form>
    <input type="text" name="imie" value="" placeholder="imie" id=imie>
    <input type="text" name="msg" value="" placeholder="wiadomosc" id="msg">
    <input type="submit" name="name" value="WYSLIJ">
  </form>
</body>
</html>


<!-- <html>
<head>
<style>
body {
font-family: "Helvetica Neue", helvetica, arial;
padding: 15px;
}

ul {
list-style: none;
margin: 0;
padding: 0;
}

ul li {
line-height: 1.4;
}
</style>

<script>
var host = location.origin.replace(/^http/, 'ws')
var ws = new WebSocket(host);
ws.onmessage = function (event) {
var li = document.createElement('li');
li.innerHTML = JSON.parse(event.data);
document.querySelector('#pings').appendChild(li);
};
</script>
</head>
<body>
<h1>Pings</h1>
<ul id='pings'></ul>
</body>
</html> -->
